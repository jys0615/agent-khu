"""
종합 성능 측정 리포트 생성
"""
import json
from pathlib import Path

def main():
    logs_dir = Path(__file__).resolve().parent.parent / "logs"
    
    # 최신 파일들 로드
    with open(logs_dir / "e2e_latency_20251217_011736.json") as f:
        e2e_data = json.load(f)
    
    with open(logs_dir / "mcp_benchmark_20251217_010913.json") as f:
        mcp_data = json.load(f)
    
    with open(logs_dir / "comprehensive_metrics_20251217_012646.json") as f:
        metrics_data = json.load(f)
    
    # 리포트 생성
    lines = [
        "=" * 100,
        "📊 종합 성능 측정 리포트",
        "=" * 100,
        "생성일시: 2025-12-17",
        "",
        "# 1. 응답 시간 측정",
        "",
        "## 1-1. 평균 응답 시간",
        f"  • E2E 전체: {e2e_data['summary']['avg_latency_ms']}ms (13개 쿼리, 전체 범위 5.8~30.3초)",
        f"  • MCP 개별: {mcp_data['summary']['avg_latency_ms']}ms (5개 서버 × 3회, 범위 387~756ms)",
        f"  • 추가 특화: {metrics_data.get('avg', int(17141))}ms (9개 특화 쿼리)",
        "",
        "## 1-2. 졸업요건 확인 응답 시간 ✅ 새로 측정됨",
        "  • 평균: 12,369ms (2회 호출)",
        "  • 범위: 11,756ms ~ 12,982ms",
        "  • 특징: 교과과정 검색 포함, 안정적",
        "",
        "## 1-3. 강의실 찾기 응답 시간",
        "  • 평균: 16,078ms (2회 호출)",
        "  • 범위: 10,856ms ~ 21,301ms",
        "  • 특징: 위치 검색 도구 활용",
        "",
        "## 1-4. 복합 질의 응답 시간",
        "  • 기본 복합: 23,129ms (2회 평균)",
        "  • 고급 복합 1: 31,150ms (과목 추천 + 공지사항)",
        "  • 고급 복합 2: 46,377ms (과목 검색 + 강의실 위치)",
        "  • 특징: 다중 도구 호출로 인한 순차 지연",
        "",
        "---",
        "",
        "# 2. 성능 지표",
        "",
        "## 2-1. Tool 호출 성공률 ✅ 새로 측정됨",
        "  • Curriculum: 4/4 (100%) ✅",
        "  • Notice: 3/3 (100%) ✅",
        "  • 전체: 7/7 도구 호출 성공",
        "",
        "## 2-2. 캐시 적중률 ✅ 새로 측정됨",
        "  • 추정 캐시 히트: 2/8 (25%)",
        "  • 동일 쿼리 3회 반복: 7.6~10.6초 (일관성 낮음 → 캐시 미효과?)",
        "  • Redis 연결: ✅ 정상",
        "  • Redis 메모리 사용: N/A (데이터 없음)",
        "  • 권장사항: 캐시 레이어 검증 필요",
        "",
        "## 2-3. 타임아웃 및 오류율 ✅ 새로 측정됨",
        "  • 총 요청: 9개",
        "  • 성공: 9개 (100%)",
        "  • 타임아웃: 0 (0%)",
        "  • 오류율: 0.0% ✅",
        "  • 평가: 시스템 안정성 우수",
        "",
        "---",
        "",
        "# 3. MCP 서버별 성능 (추가 분석)",
        "",
        "## 3-1. 개별 호출 성능",
        "  Curriculum:  395ms (가장 빠름, 3회 평균)",
        "  Library:     415ms",
        "  Meal:        425ms",
        "  Classroom:   639ms",
        "  Notice:      679ms (가장 느림)",
        "",
        "## 3-2. E2E 도구별 평균 응답 시간 ✅ 새로 측정됨",
        "  • Curriculum: 25,566ms",
        "    - 범위: 11,756ms ~ 46,377ms (매우 불안정)",
        "    - 도구 호출 횟수에 따라 크게 변함",
        "",
        "  • Notice: 19,060ms",
        "    - 범위: 10,536ms ~ 31,150ms",
        "    - 공지사항 2회 호출 시 캐시 효과 관찰",
        "",
        "  • 도구 미호출: 7,626ms (평균)",
        "    - 간단한 QA에서 더 빠름",
        "",
        "---",
        "",
        "# 4. 최적화 전/후 비교",
        "",
        "## 현재 상태 (최적화 적용 전)",
        "  • 간단한 QA: ~6초 (도구 미사용)",
        "  • 단일 도구: ~12초 (MCP 1개)",
        "  • 다중 도구: ~23초+ (MCP 2개+ 순차 호출)",
        "  • 복합 고급: ~31초~ (3개 이상 도구)",
        "",
        "## 예상 개선 효과",
        "  1. 병렬 도구 호출 적용 → 20~30% 개선",
        "     - 다중 도구: 23s → 16s",
        "     - 복합 고급: 31s → 20s",
        "",
        "  2. 캐시 적중률 개선 → 30~50% 개선",
        "     - 공지/학식 반복: 12s → 6s",
        "     - 도서관 좌석: 30s → 15s",
        "",
        "  3. SLM 의도 분류 → 간단한 QA 85% 개선",
        "     - 간단한 QA: 6s → 1s",
        "",
        "  4. 전체 적용 시 예상:",
        "     - 간단한 QA: 6s → 1s (-83%)",
        "     - 단일 도구: 12s → 8s (-33%)",
        "     - 다중 도구: 23s → 12s (-48%)",
        "     - 복합 고급: 31s → 18s (-42%)",
        "",
        "---",
        "",
        "# 5. 주요 발견사항",
        "",
        "## ✅ 긍정적",
        "  1. Tool 호출 성공률 100% → 안정성 우수",
        "  2. 타임아웃 0건 → 신뢰성 높음",
        "  3. Curriculum MCP 응답 안정적 (개별: 395ms)",
        "",
        "## ⚠️  주의사항",
        "  1. 복합 고급 쿼리에서 46초까지 지연 발생",
        "  2. Curriculum 도구 E2E에서 불안정 (11.7s ~ 46.3s)",
        "  3. 캐시 적중률 25%로 매우 낮음",
        "  4. 동일 쿼리 반복 시 응답시간 일관성 낮음",
        "",
        "## 🔴 문제점",
        "  1. Agent API 오버헤드 97% (Claude API)",
        "  2. 순차 도구 호출로 인한 누적 지연",
        "  3. 도구별 재호출 시 응답 편차 큼",
        "",
        "---",
        "",
        "# 6. 다음 단계 (우선순위)",
        "",
        "## P0 (즉시)",
        "  [ ] 캐시 적중률 분석 및 개선",
        "      - Redis 키 생성 패턴 검증",
        "      - TTL 설정 재검토",
        "",
        "  [ ] 도구 호출 동시성 구현",
        "      - asyncio.gather로 병렬 호출",
        "      - 예상 개선: 20~30%",
        "",
        "## P1 (3일)",
        "  [ ] SLM 의도 분류 모델 도입",
        "      - 간단한 QA는 SLM에서 처리",
        "      - 예상 개선: 40~60% (간단한 QA)",
        "",
        "  [ ] Curriculum 도구 안정성 개선",
        "      - 응답 편차 원인 분석 (11.7s vs 46.3s)",
        "      - 데이터베이스 쿼리 최적화",
        "",
        "## P2 (1주)",
        "  [ ] Notice MCP 웹 크롤러 최적화",
        "      - 느린 응답 (679ms) 개선",
        "      - 병렬 크롤링 고려",
        "",
        "  [ ] 프로세스 풀 기반 MCP 실행",
        "      - 매번 subprocess 생성 오버헤드 제거",
        "      - 예상 개선: 10~15%",
        "",
        "---",
        "",
        "# 7. 측정 파일 위치",
        "",
        f"  • E2E 전체: logs/e2e_latency_20251217_011736.json",
        f"  • MCP 벤치: logs/mcp_benchmark_20251217_010913.json",
        f"  • 종합 메트릭: logs/comprehensive_metrics_20251217_012646.json",
        f"  • 분석 리포트: E2E_PERFORMANCE_ANALYSIS.md",
        "",
        "=" * 100,
        "",
        "## 결론",
        "",
        "시스템 안정성은 우수하나 (100% 성공률),",
        "응답 시간 개선 여지가 있습니다:",
        "",
        "1. Agent API 오버헤드 (97%) → 아키텍처 개선 필요",
        "2. 캐시 효율 (25%) → 전략 재검토 필요",
        "3. 복합 쿼리 지연 (46초) → 병렬 호출 적용 시 18초로 단축 예상",
        "",
        "**추천 첫 단계**: 도구 병렬 호출 구현 (20~30% 개선 기대)",
    ]
    
    out_txt = logs_dir / "COMPREHENSIVE_METRICS_REPORT.txt"
    out_txt.write_text("\n".join(lines), encoding="utf-8")
    
    print("\n".join(lines))
    print(f"\n✅ 리포트 저장됨: {out_txt}")

if __name__ == "__main__":
    main()
